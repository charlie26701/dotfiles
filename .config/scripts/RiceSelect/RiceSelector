#!/usr/bin/env bash

color_dir="$HOME/.config/scripts/Themes"
rofi_command="rofi -dmenu -theme $HOME/.config/scripts/RiceSelect/RiceSelector.rasi"

options=()
for file in "$color_dir"/*; do
	options+=("$(basename "$file")")
done

color=$(printf "%s\n" "${options[@]}" | $rofi_command)

source ~/.config/scripts/Themes/$color

term() {
	sed -i -e "s/include .*/include $color.conf/" "$HOME"/.config/kitty/kitty.conf
    sed -i -e "s/colors: .*/colors: *$color/" ~/.config/alacritty/colors.yml
}

gtk() {
	sed -i -e "s/background:.*/background:$bg/"\
		   -e "s/background_alt:.*/background_alt:$bgl3/"\
		   -e "s/foreground:.*/foreground:$fg/"\
		   -e "s/accent:.*/accent:$accent/" ~/.themes/tethemes/gtk-2.0/gtkrc

	sed -i -e "s/background .*/background $bg;/"\
		   -e "s/background_alt .*/background_alt $bgl3;/"\
		   -e "s/background_urgent .*/background_urgent $bgl4;/"\
		   -e "s/foreground .*/foreground $fg;/"\
		   -e "s/accent .*/accent $accent;/" ~/.themes/tethemes/gtk-3.0/colors.css
}

discord() {
	cat ~/.config/BetterDiscord/data/stable/themes/$color.css > ~/.config/BetterDiscord/data/stable/custom.css
}

spotify() {
	spicetify config color_scheme $color && spicetify apply
}

rofi() {
	echo '* { background: '$bgd'; background-alt: '$bgl'; border-color: '$bgl3'; foreground: '$fg'; }' > ~/.config/scripts/.theme_rofi.rasi
}

firefox() {
	sed -i -e "s/background: .*/background: $bg !important;/"\
		   -e "s/background-color: .*/background-color: $bg !important;/"\
		   -e "s/color: .*/color: $bg !important;/" ~/.config/firefox/chrome/userContent.css

	sed -i -e "s/--uc-base-colour: .*/--uc-base-colour: $bgl;/"\
		   -e "s/--uc-highlight-colour: .*/--uc-highlight-colour: $bg;/"\
		   -e "s/--uc-inverted-colour: .*/--uc-inverted-colour: $fg;/"\
		   -e "s/--uc-identity-colour-red: .*/--uc-identity-colour-red: $red;/"\
		   -e "s/--uc-identity-colour-green: .*/--uc-identity-colour-green: $green;/"\
		   -e "s/--uc-identity-colour-blue: .*/--uc-identity-colour-blue: $blue;/"\
		   -e "s/--uc-identity-colour-yellow: .*/--uc-identity-colour-yellow: $yellow;/"\
		   -e "s/--uc-identity-colour-orange: .*/--uc-identity-colour-orange: $orange;/" ~/.config/firefox/chrome/includes/cascade-colours.css
	rm -r ~/.mozilla/firefox/*.default-release/chrome/* && cp -r ~/.config/firefox/chrome/* ~/.mozilla/firefox/*.default-release/chrome/
}

nvim() {
    reload="python $HOME/.config/scripts/reload_nvim.py"
    reload_cmd="$reload 'lua require(\"themes.switch\").settheme(\"$color\")'"
    eval "$reload_cmd"
	new_line="vim.g.currentTheme = \"$color\""
	sed -i "s/vim.g.currentTheme = .*/$new_line/" "$HOME/.config/nvim/lua/user/options.lua"
}

backup() {
	declare -a config_folders=("awesome" "alacritty" "zsh" "ranger" "scripts" "firefox")
	declare -a data_folders=("BetterDiscord/data/stable" "spicetify/Themes")
	declare -a dot_folders=("fonts" "icons" "themes" "walls")

	rm -rf ~/dotfiles/{.config,.fonts,.icons,.themes,.walls,.local}
	mkdir -p ~/dotfiles/{.config,.fonts,.icons,.themes,.walls,.local}
		
	for folder in "${dot_folders[@]}"; do
		cp -r ~/."$folder"/* ~/dotfiles/.${folder}/
	done

	for folder in "${config_folders[@]}"; do
		cp -r ~/.config/"$folder" ~/dotfiles/.config/
	done

	for folder in "${data_folders[@]}"; do
		mkdir -p ~/dotfiles/.config/"$folder"
		cp -r ~/.config/"$folder"/* ~/dotfiles/.config/"$folder"
	done

	cp -r ~/.local/other/ ~/dotfiles/.local/ && cp -r ~/.local/bin/ ~/dotfiles/.local/
	rm -f ~/dotfiles/.Xresources && cp ~/.Xresources ~/dotfiles/
}

if [[ -n "$color" ]]; then
	term
	gtk
	spotify
	discord
	firefox
	rofi
	nvim
	awesome
	backup
	awesome-client "awesome.restart()"
fi


exit 0
