#!/bin/bash

if [[ $EUID -ne 0 ]]; then
    echo "Use sudo please." >&2
    exit 1
fi

echo ">>> Config Secure Boot..."
sudo grub-install --target=x86_64-efi --efi-directory=/boot --bootloader-id=GRUB --modules="tpm" --disable-shim-lock
sudo grub-mkconfig -o /boot/grub/grub.cfg

# Craete keys and sign Secure Boot
sudo sbctl create-keys
sudo sbctl sign -s /boot/EFI/GRUB/grubx64.efi
sudo sbctl sign -s /boot/EFI/Boot/bootx64.efi
sudo sbctl sign -s /boot/vmlinuz-linux
sudo sbctl enroll-keys -mi

sleep 5 && clear

echo ">>> Config driver NVIDIA..."
# Open [multilib] repository
sudo sed -i '/\[multilib\]/,/Include/ s/^#//' /etc/pacman.conf

# Reupdate all
sudo pacman -Syu --needed --noconfirm
sudo pacman -S --needed nvidia-open nvidia-utils lib32-nvidia-utils nvidia-settings vulkan-icd-loader lib32-vulkan-icd-loader nvidia-prime --noconfirm

# Add nvidia_drm.modeset=1 on GRUB
sudo sed -i 's/GRUB_CMDLINE_LINUX_DEFAULT="/GRUB_CMDLINE_LINUX_DEFAULT="nvidia_drm.modeset=1 /' /etc/default/grub
sudo grub-mkconfig -o /boot/grub/grub.cfg

echo ">>> SUCCESS. REBOOTING..."
sleep 3 && reboot
