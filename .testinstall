#!/bin/bash

set -e  # Dừng script nếu có lỗi
set -u  # Lỗi nếu sử dụng biến chưa được định nghĩa
set -o pipefail  # Bắt lỗi trong pipeline

# Kiểm tra Internet
echo ">>> Kiểm tra kết nối Internet..."
ping -c 3 archlinux.org || { echo "Không có kết nối Internet!"; exit 1; }

# Đồng bộ thời gian và thiết lập bàn phím
echo ">>> Đồng bộ thời gian và thiết lập bàn phím..."
timedatectl set-ntp true
timedatectl set-timezone Asia/Ho_Chi_Minh
loadkey us

# Cập nhật mirrorlist
echo ">>> Cập nhật mirrorlist..."
pacman -Sy reflector archlinux-keyring --noconfirm
reflector -c Vietnam -c Singapore -c Japan -c India -a 12 --sort rate --save /etc/pacman.d/mirrorlist

# Phân vùng và định dạng ổ đĩa
echo ">>> Phân vùng và định dạng ổ đĩa..."
cfdisk /dev/nvme0n1 || { echo "Hãy kiểm tra phân vùng thủ công."; exit 1; }

# Kiểm tra phân vùng
lsblk /dev/nvme0n1
read -p "Đã hoàn thành việc phân vùng? Nhấn Enter để tiếp tục..."

mkswap /dev/nvme0n1p6
swapon /dev/nvme0n1p6

mkfs.ext4 /dev/nvme0n1p5
mount /dev/nvme0n1p5 /mnt
mkdir -p /mnt/boot
mount /dev/nvme0n1p3 /mnt/boot

# Cài đặt hệ thống cơ bản
echo ">>> Cài đặt hệ thống cơ bản..."
pacstrap /mnt base base-devel linux linux-firmware linux-headers sbctl neovim

# Tạo fstab và chuyển vào môi trường chroot
echo ">>> Tạo fstab và chuyển vào môi trường chroot..."
genfstab -U /mnt >> /mnt/etc/fstab
arch-chroot /mnt /bin/bash << "EOF"

# Cấu hình thời gian và ngôn ngữ
ln -sf /usr/share/zoneinfo/Asia/Ho_Chi_Minh /etc/localtime
hwclock --systohc
echo "en_US.UTF-8 UTF-8" >> /etc/locale.gen
locale-gen
echo LANG=en_US.UTF-8 > /etc/locale.conf

# Cấu hình hostname và hosts
echo arch > /etc/hostname
cat << EOL >> /etc/hosts
127.0.0.1	localhost
::1		localhost
127.0.1.1	arch.localdomain	arch
EOL

# Cài đặt mật khẩu root
echo ">>> Đặt mật khẩu root..."
passwd

# Thêm người dùng
useradd -m sowntee
passwd sowntee
usermod -aG wheel,audio,video,optical,storage,power sowntee

# Cấu hình sudo
echo ">>> Cấu hình sudo..."
EDITOR=nvim visudo

# Cài đặt mạng
echo ">>> Cài đặt NetworkManager..."
pacman -S --noconfirm networkmanager wpa_supplicant wireless_tools
systemctl enable NetworkManager

# Cài đặt GRUB
echo ">>> Cài đặt GRUB..."
pacman -S --noconfirm grub os-prober efibootmgr ntfs-3g mtools dosfstools
sed -i 's/^#GRUB_DISABLE_OS_PROBER=false/GRUB_DISABLE_OS_PROBER=false/' /etc/default/grub
grub-install --target=x86_64-efi --efi-directory=/boot --bootloader-id=GRUB
grub-mkconfig -o /boot/grub/grub.cfg

# Secure Boot (tuỳ chọn)
# echo ">>> Cấu hình Secure Boot..."
# sbctl create-keys
# sbctl sign -s /boot/EFI/GRUB/grubx64.efi
# sbctl sign -s /boot/EFI/Boot/bootx64.efi
# sbctl sign -s /boot/vmlinuz-linux
# sbctl enroll-keys -mi

EOF

# Hoàn tất và khởi động lại
echo ">>> Hoàn tất. Sẵn sàng khởi động lại!"
umount -R /mnt
reboot
