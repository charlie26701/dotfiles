#!/usr/bin/env bash

# WARNING: THIS IS MY PERSONAL SCRIPT WHEN I REINSTALL ARCH, IT MAY NOT WORK FOR YOU!

pkg_installed() {
	local PKG=$1
	if pacman -Qi $PKG &>/dev/null; then
		return 0
	else
		return 1
	fi
}

# Update
sudo sudo pacman -Syu --noconfirm
sleep 3 && clear

# Git
echo "[*] Installing git ..."
if pkg_installed git; then
	echo "[*] Git already installed, skipping ..."
else
	sudo pacman -S git --noconfirm
	echo "[*] Git Installed."
fi

# Yay
echo "[*] Installing AUR helper(yay) ..."
if pkg_installed yay; then
	echo "[*] Yay already installed, skipping ..."
else
	git clone https://aur.archlinux.org/yay.git && cd yay
	makepkg -si
	cd .. && rm -rf yay
	echo "[*] Yay Installed."
fi
cd ~
sleep 3 && clear

# Install Dotf
echo "[*] Installing dotfiles ..."
git clone https://github.com/sownteedev/dotfiles.git --depth=1 --branch=dotf ~/Dotfiles/dotf
clear
git clone https://github.com/sownteedev/dotfiles.git --depth=1 --branch=main ~/Dotfiles/main
echo "[*] Done."
sleep 3 && clear

#################################################### INSTALL DRIVER AND APPS ####################################################
# Install library
echo "[*] Installing library ..."
sudo pacman -S nodejs npm yarn python python-pip clang jdk-openjdk rustup cargo --noconfirm && yay -S nvm --noconfirm
echo "[*] Done."
sleep 3 && clear

# Audio
echo "[*] Installing audio & mic driver ..."
sudo pacman -S pavucontrol pipewire pipewire-audio pipewire-pulse alsa-ucm-conf sof-firmware playerctl --noconfirm
sudo systemctl --user enable pipewire pipewire-pulse wireplumber
echo "[*] Done."
sleep 3 && clear

# Brightness
echo "[*] Installing brightness ..."
sudo pacman -S brightnessctl --noconfirm
echo "[*] Done."
sleep 3 && clear

# Battery
echo "[*] Installing battery ..."
sudo pacman -S acpi acpid upower power-profiles-daemon --noconfirm
sudo systemctl enable acpid upower power-profiles-daemon
echo "[*] Done."
sleep 3 && clear

# Network
echo "[*] Installing network ..."
sudo pacman -S networkmanager wpa_supplicant wireless_tools network-manager-applet --noconfirm
sudo systemctl enable NetworkManager wpa_supplicant
LOC="/etc/NetworkManager/conf.d/wifi-powersave.conf"
echo -e "The following has been added to $LOC.\n"
echo -e "[connection]\nwifi.powersave = 2" | sudo tee -a $LOC
echo "[*] Done."
sleep 3 && clear

# Bluetooth
echo "[*] Installing bluetooth driver ..."
sudo pacman -S bluez bluez-utils bluez-libs blueman --noconfirm
sudo systemctl enable bluetooth.service
sleep 3 && clear

# File manager
echo "[*] Installing file manager ..."
sudo pacman -S nemo nemo-fileroller tumbler ranger ueberzug exa zip gzip tar unzip unrar xdg-user-dirs gvfs vlc evince glib2 dconf --noconfirm
gsettings set org.nemo.desktop show-desktop-icons true
echo "[*] Done."
sleep 3 && clear

# Monitor and Theme
echo "[*] Installing monitor and theme ..."
sudo pacman -S viewnior shotwell nwg-look imagemagick fastfetch --noconfirm
echo "[*] Done."
sleep 3 && clear

# Other
echo "[*] Installing other ..."
sudo pacman -S --noconfirm devtools gnome-keyring polkit-gnome libgnome-keyring seahorse pacman-contrib github-cli wget zsh && yay -S --noconfirm inotify-tools xfce4-taskmanager-git
echo "[*] Done."
sleep 3 && clear

# Fix Driver audio (for me)
echo "[*] Fixing audio driver ..."
sudo pacman -S rsync --noconfirm && cd ~
mkdir -p ~/old-sof-backup
sudo mv /lib/firmware/intel/sof* ~/old-sof-backup
sudo mv /usr/local/bin/sof-* ~/old-sof-backup

git clone https://github.com/thesofproject/sof-bin.git && cd sof-bin/v2.1.x
sudo rsync -a sof*v2.1.1 /lib/firmware/intel/
sudo ln -s sof-v2.1.1 /lib/firmware/intel/sof
sudo ln -s sof-tplg-v2.1.1 /lib/firmware/intel/sof-tplg
sudo rsync tools-v2.1.1/* /usr/local/bin

cd ~ && git clone https://github.com/thesofproject/alsa-ucm-conf.git && cd alsa-ucm-conf
sudo rm -r /usr/share/alsa/ucm
sudo mv ./ucm /usr/share/alsa

cd ~ && sudo rm -rf sof-bin alsa-ucm-conf old-sof-backup
echo "[*] Done."
sleep 3 && clear

echo ">>> Config Secure Boot..."
sudo grub-install --target=x86_64-efi --efi-directory=/boot --bootloader-id=GRUB --modules="tpm" --disable-shim-lock
sudo grub-mkconfig -o /boot/grub/grub.cfg

# Craete keys and sign Secure Boot
sudo sbctl create-keys
sudo sbctl sign -s /boot/EFI/GRUB/grubx64.efi
sudo sbctl sign -s /boot/EFI/Boot/bootx64.efi
sudo sbctl sign -s /boot/vmlinuz-linux
sudo sbctl enroll-keys -mi

sleep 3 && clear

echo ">>> Config driver NVIDIA..."
# Open [multilib] repository
sudo sed -i '/\[multilib\]/,/Include/ s/^#//' /etc/pacman.conf

# Reupdate all
sudo pacman -Syu --needed --noconfirm
sudo pacman -S --needed nvidia-open nvidia-utils lib32-nvidia-utils nvidia-settings vulkan-icd-loader lib32-vulkan-icd-loader nvidia-prime --noconfirm

# Add nvidia_drm.modeset=1 on GRUB
sudo sed -i 's/loglevel=3 quiet/nvidia_drm.modeset=1 quiet/' /etc/default/grub
sudo grub-mkconfig -o /boot/grub/grub.cfg

echo "[*] Done. Rebooting your system..."
sleep 3 && reboot
