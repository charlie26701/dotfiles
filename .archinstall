#!/bin/bash

set -e
set -u
set -o pipefail

echo ">>> Check Internet..."
ping -c 3 archlinux.org || { echo "Not Found Internet!"; exit 1; }

echo ">>> Sync time and set keyboard..."
loadkeys i386/qwerty/us.map.gz
timedatectl set-ntp true
timedatectl set-timezone Asia/Ho_Chi_Minh

echo ">>> Update mirrorlist..."
pacman -Sy reflector archlinux-keyring --noconfirm
reflector -c Vietnam -c Singapore -c Japan -c India -a 12 --sort rate --save /etc/pacman.d/mirrorlist

cfdisk /dev/nvme0n1 || { echo "Check disk."; exit 1; }

lsblk /dev/nvme0n1
read -p "All right? Press Enter to continue..."

mkswap /dev/nvme0n1p6
swapon /dev/nvme0n1p6

mkfs.ext4 /dev/nvme0n1p5
mount /dev/nvme0n1p5 /mnt
mkdir -p /mnt/boot
mount /dev/nvme0n1p3 /mnt/boot

lsblk /dev/nvme0n1
sleep 5 && clear

echo ">>> Basic install..."
pacstrap /mnt base base-devel linux linux-firmware linux-headers sbctl neovim

echo ">>> Create fstab and go to chroot..."
genfstab -U /mnt >> /mnt/etc/fstab

# Type all information before go to chroot
echo "Type hostname:"
read hostname
echo "Type root password:"
read -s rootpassword
echo "Type username:"
read username
echo "Type password $username:"
read -s userpassword

arch-chroot /mnt /bin/bash << EOF

# Time and languaue
ln -sf /usr/share/zoneinfo/Asia/Ho_Chi_Minh /etc/localtime
hwclock --systohc
echo "en_US.UTF-8 UTF-8" >> /etc/locale.gen
locale-gen
echo LANG=en_US.UTF-8 > /etc/locale.conf

# Config hostname and hosts
echo "$hostname" > /etc/hostname
cat << EOL > /etc/hosts
127.0.0.1	localhost
::1		localhost
127.0.1.1	$hostname.localdomain	$hostname
EOL

# Root password
echo "root:$rootpassword" | chpasswd

# User and password
useradd -m $username
echo "$username:$userpassword" | chpasswd
usermod -aG wheel,audio,video,optical,storage,power $username

echo ">>> Config sudo..."
EDITOR=nvim visudo

echo ">>> Installing NetworkManager..."
pacman -S --noconfirm networkmanager wpa_supplicant wireless_tools
systemctl enable NetworkManager

echo ">>> Installing GRUB..."
pacman -S --noconfirm grub os-prober efibootmgr ntfs-3g mtools dosfstools
sed -i 's/^#GRUB_DISABLE_OS_PROBER=false/GRUB_DISABLE_OS_PROBER=false/' /etc/default/grub
grub-install --target=x86_64-efi --efi-directory=/boot --bootloader-id=GRUB
grub-mkconfig -o /boot/grub/grub.cfg

EOF

echo ">>> SUCCES. REBOOTING!"
umount -R /mnt
reboot
