#!/bin/bash

set -e
set -u
set -o pipefail

echo ">>> Check Internet..."
ping -c 3 archlinux.org || { echo "Not Found Internet!"; exit 1; }

echo ">>> Sync time and set keyboard..."
# Load keyboard layout
if loadkeys i386/qwerty/us.map.gz; then
  echo "Keyboard layout set successfully."
else
  echo "Failed to set keyboard layout. Please check the file path."
  exit 1
fi
# Synchronize time
if timedatectl set-ntp true; then
  echo "Time synchronization enabled."
else
  echo "Failed to enable time synchronization."
  exit 1
fi
# Set timezone
if timedatectl set-timezone Asia/Ho_Chi_Minh; then
  echo "Timezone set to Asia/Ho_Chi_Minh."
else
  echo "Failed to set timezone."
  exit 1
fi

echo ">>> Update mirrorlist..."
pacman -Sy reflector archlinux-keyring --noconfirm
if reflector -c Vietnam -c Singapore -c Japan -c India -a 12 --sort rate --save /etc/pacman.d/mirrorlist; then
  echo "Mirrorlist updated successfully."
else
  echo "Failed to update mirrorlist. Please check reflector settings."
  exit 1
fi


# DISK
read -p "Enter the disk you want to partition (e.g., sda or nvme0n1): " disk

if [ ! -e "/dev/$disk" ]; then
  echo "Disk /dev/$disk not found. Exiting..."
  exit 1
fi

cfdisk /dev/$disk || { echo "Check disk."; exit 1; }

lsblk /dev/$disk
read -p "All right? Press Enter to continue..."

read -p "Enter the partition number for swap (e.g., 6 for /dev/${disk}p6): " swap_part
read -p "Enter the partition number for file system (e.g., 5 for /dev/${disk}p5): " fs_part
read -p "Enter the partition number for boot (e.g., 3 for /dev/${disk}p3): " boot_part

mkswap /dev/${disk}p${swap_part}
swapon /dev/${disk}p${swap_part}

mkfs.ext4 /dev/${disk}p${fs_part}
mount /dev/${disk}p${fs_part} /mnt

mkdir -p /mnt/boot
mount /dev/${disk}p${boot_part} /mnt/boot

lsblk /dev/$disk
sleep 5 && clear

# Chroot
echo ">>> Basic install..."
pacstrap /mnt base base-devel linux linux-firmware linux-headers sbctl neovim

echo ">>> Create fstab and go to chroot..."
genfstab -U /mnt >> /mnt/etc/fstab

# Type all information before go to chroot
read -p "Type hostname: " hostname
read -s -p "Type root password: " rootpassword
echo
read -p "Type username: " username
read -s -p "Type password for $username: " userpassword
echo

arch-chroot /mnt /bin/bash << EOF

# Time and languaue
ln -sf /usr/share/zoneinfo/Asia/Ho_Chi_Minh /etc/localtime
hwclock --systohc
echo "en_US.UTF-8 UTF-8" >> /etc/locale.gen
locale-gen
echo LANG=en_US.UTF-8 > /etc/locale.conf

# Config hostname and hosts
echo "$hostname" > /etc/hostname
cat << EOL > /etc/hosts
127.0.0.1	localhost
::1		localhost
127.0.1.1	$hostname.localdomain	$hostname
EOL

# Root password
echo "root:$rootpassword" | chpasswd

# User and password
useradd -m $username
echo "$username:$userpassword" | chpasswd
usermod -aG wheel,audio,video,optical,storage,power $username

echo ">>> Config sudo..."
EDITOR=nvim visudo

echo ">>> Installing NetworkManager..."
pacman -S --noconfirm networkmanager wpa_supplicant wireless_tools
systemctl enable NetworkManager

echo ">>> Installing GRUB..."
pacman -S --noconfirm grub os-prober efibootmgr ntfs-3g mtools dosfstools
sed -i 's/^#GRUB_DISABLE_OS_PROBER=false/GRUB_DISABLE_OS_PROBER=false/' /etc/default/grub
grub-install --target=x86_64-efi --efi-directory=/boot --bootloader-id=GRUB
grub-mkconfig -o /boot/grub/grub.cfg

EOF

echo ">>> SUCCES. REBOOTING!"
umount -R /mnt
reboot
